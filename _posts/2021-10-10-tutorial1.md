---
title:  "Tutorial 1: Get to know your tools"
layout: post
tag: developer
---

# Get to know your tools

These developer notes assume almost no knowledge. The goal is to learn everything required to write a bare metal operating system for the STM32 by playing and experimentation, diving deeper each iteration and trying to accomplish progressively more difficult tasks.




# Essential Software 

1. Ghidra, for decompiling the system firmware and annotating it.
2. OpenOCD, for connecting your laptop debugger to the microcontroller and setting up a gdb instance.
3. GDB, for debugging.
4. Python for general scripting.
5. The [rtmidi](https://github.com/SpotlightKid/python-rtmidi) python package, available on pip.
6. The arm-none-eabi-gcc cross-compiler toolchain.

# Essential Tools

1. [An ST-Link/V2 debugger for the STM32 architecture.](https://www.amazon.com/ST-LINK-V2-circuit-debugger-programmer/dp/B00SDTEM1I/ref=sr_1_3?dchild=1&keywords=st-link%2Fv2+debugger&qid=1618172788&sr=8-3). It costs about $30. Get the real one.
2. A screw driver to open the keyboard and seperate the top plate from the bottom.

# Operating System Developer Only

If you don't want to open the device or buy anything beyond a USB cable, you can develop, compile, and burn Open Klave to the MPK2 series using just Ghidra, python, and the arm-none-eabi-gcc tools. However, it's highly reccommended to get your hands dirty and get all the tools, as there is an essential learning loop between poking the machine in gdb, and learning how to write good routines in c. 

## Diving in

You can do a lot with just python. You can send sysex commands to the MPK2 device and its factory operating system, for example by using rtmidi to send midi messages from your laptop to the device. Doing this, you can change the colors on the keypads, and even intercept and modify midi messages between the device and your software. You can do just about everything but send messages to the LCD or get extended keypad colors. [This is a great resource](http://practicalusage.com/akai-mpk261-mpk2-series-controlling-the-controller-with-sysex/) to play around with that, and [this is even better](https://github.com/nsmith-/mpk2).

The goal of these notes and operating system is to permit keyboard owners to execute arbitrary code with only a USB cable, on top of a lightweight and accommodating operating system. Go get your screw driver and let's see what we can learn.

### Investigating the firmware

Unscrew the screws at the bottom of your keyboard, and investigate the primary printed circuit board.

<p align="center">
  <img width="460" height="300" src="/pics/mpk249pcb.jpg">
</p>

We notice two things. First, its brain is a microcontroller called an STM32F103. Second, it has a 16 pin JTAG connector so you can debug it.
The ST-Link/V2 you bought earlier has a connector which fits snuggly over the JTAG port.

#### A note on the STM32F103

The STM32F103 runs an instruction set called ARM Cortex M3. The chip is 32-bit and little-endian, which will be important for setting up Ghidra and sending values to it later.

#### Accompanying software

We assume you have installed:

1. Ghidra, for decompiling the system firmware and annotating it.
2. OpenOCD, for connecting your laptop debugger to the microcontroller and setting up a gdb instance.
3. GDB, for debugging.
4. A python installation with rtmidi (pip install), so you can send midi and sysex messages to the keyboard.

Here's what it should look like once you have the ST-Link/V2 plugged in to the MPK2. Note that this requires 2 usb connections to work. So you'll have the ST-LINK/v2 connected to the JTAG port and plugged into your computer's USB, and you'll have a second USB connection to the back of the keyboard, to power and send messages to it, like you would usually.
